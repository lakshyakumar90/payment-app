generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
}

enum AccountStatus {
  ACTIVE
  FROZEN
  CLOSED
}

enum TransactionType {
  TRANSFER
  DEPOSIT
  WITHDRAWAL
}

enum TransactionStatus {
  PENDING
  COMPLETED
  FAILED
}

model User {
  id           String  @id @default(cuid())
  email        String  @unique
  phone        String? @unique
  passwordHash String
  fullName     String

  isActive Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  accounts Account[]
  sessions Session[]

  @@index([email])
  @@index([phone])
}

model Session {
  id               String   @id @default(cuid())
  userId           String
  refreshTokenHash String   @unique
  expiresAt        DateTime
  isRevoked        Boolean  @default(false)

  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Account {
  id            String @id @default(cuid())
  userId        String
  accountNumber String @unique

  // Money stored as smallest currency unit (e.g., paise for INR, cents for USD)
  balance          BigInt @default(0)
  availableBalance BigInt @default(0)

  currency      String        @default("INR")
  decimalPlaces Int           @default(2) // 2 for INR/USD (100 paise = 1 rupee)
  status        AccountStatus @default(ACTIVE)
  isPrimary     Boolean       @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user                 User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  sentTransactions     Transaction[]    @relation("SenderAccount")
  receivedTransactions Transaction[]    @relation("ReceiverAccount")
  balanceHistory       BalanceHistory[]

  @@index([userId])
  @@index([accountNumber])
  @@index([status])
}

model Transaction {
  id            String @id @default(cuid())
  transactionId String @unique

  senderAccountId   String?
  receiverAccountId String?

  // Money stored as smallest currency unit (e.g., paise for INR)
  amount        BigInt @default(0)
  currency      String @default("INR")
  decimalPlaces Int    @default(2) // 2 for INR/USD

  transactionType TransactionType
  status          TransactionStatus @default(PENDING)

  createdAt       DateTime  @default(now())
  completedAt     DateTime?
  senderAccount   Account?  @relation("SenderAccount", fields: [senderAccountId], references: [id])
  receiverAccount Account?  @relation("ReceiverAccount", fields: [receiverAccountId], references: [id])

  @@index([transactionId])
  @@index([senderAccountId])
  @@index([receiverAccountId])
  @@index([status])
  @@index([createdAt])
}

model BalanceHistory {
  id        String @id @default(cuid())
  accountId String

  // Money stored as smallest currency unit (e.g., paise for INR)
  balance       BigInt @default(0)
  change        BigInt @default(0)
  decimalPlaces Int    @default(2) // 2 for INR/USD
  reason        String

  createdAt DateTime @default(now())

  account Account @relation(fields: [accountId], references: [id], onDelete: Cascade)

  @@index([accountId])
  @@index([createdAt])
}
